version: '3.7'

networks:
  feelback:

services:
  certbot:
    image: certbot/certbot
    volumes:
      - ./docker/certbot/conf:/etc/letsencrypt
      - ./docker/certbot/www:/var/www/certbot
    networks:
      - feelback

  feelback-web:
    container_name: feelback-web
    networks:
      - feelback
    ports:
      - '80:80'
      - '443:443'

  feelback-api:
    container_name: 'feelback-api'
    depends_on:
      - feelback-db
      - identity-db
    networks:
      - feelback
    ports:
      - ${FB_API_PORT}:${FB_API_PORT}

  pgadmin:
    image: dpage/pgadmin4
    container_name: 'feelback-pgadmin'
    depends_on:
      - feelback-db
      - identity-db
    ports:
      - ${PGA_PORT}:80
    networks:
      - feelback

  feelback-db:
    image: postgres:11-alpine
    container_name: 'feelback-db-feelback'
    networks:
      - feelback

  identity-db:
    image: postgres:11-alpine
    container_name: 'feelback-db-identity'
    networks:
      - feelback

  keycloak-db:
    image: postgres:11-alpine
    container_name: 'feelback-db-keycloak'
    networks:
      - feelback

  keycloak:
    image: jboss/keycloak:10.0.1
    container_name: 'feelback-keycloak'
    depends_on:
      - keycloak-db
    volumes:
      - ./docker/keycloak/realms:/opt/jboss/keycloak/imports
    command: -Dkeycloak.migration.action=import -Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=/opt/jboss/keycloak/imports/feelback.realm.json -Dkeycloak.migration.strategy=OVERWRITE_EXISTING
    ports:
      - ${KEYCLOAK_PORT:-8080}:8080
    networks:
      - feelback
